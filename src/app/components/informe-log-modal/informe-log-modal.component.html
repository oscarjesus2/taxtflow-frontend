<!-- informe-log-modal.component.html -->
<!-- ================================================= -->
<!--            Historial del informe (Árbol)          -->
<!-- ================================================= -->

<h5 class="modal-title">Historial del informe</h5>

<!-- Spinner mientras carga -->
<div *ngIf="cargando" class="py-4 text-center">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Cargando…</span>
  </div>
</div>

<!-- Contenido -->
<div *ngIf="!cargando" class="pt-2">

  <!-- Recorremos FASES -->
  <div *ngFor="let fase of agrupado" class="mb-3">

    <!-- Botón cabecera FASE -->
    <button class="btn btn-sm btn-secondary w-100 text-start"
            data-bs-toggle="collapse"
            [attr.data-bs-target]="'#fase_' + fase.fase">
      <i class="fas fa-chevron-right me-1 collapse-indicator"
         [class.rotate-90]="false"></i>
      {{ fase.fase }}
    </button>

    <!-- Cuerpo FASE -->
    <div class="collapse" [id]="'fase_' + fase.fase">

      <!-- Recorremos INTENTOS automáticos dentro de la fase -->
      <div *ngFor="let att of fase.attempts" class="mt-2 ms-3">

        <button class="btn btn-sm btn-light w-100 text-start"
                data-bs-toggle="collapse"
                [attr.data-bs-target]="'#att_' + fase.fase + '_' + att.reintentoOfUsuario + '_' + att.numeroIntento">
          <i class="fas fa-chevron-right me-1 collapse-indicator"></i>
          Reproceso #{{ att.reintentoOfUsuario }} – Int {{ att.numeroIntento }}
          <span class="badge bg-secondary ms-2">{{ att.statusCode }}</span>
        </button>

        <!-- Detalle intento -->
        <div class="collapse" 
             [id]="'att_' + fase.fase + '_' + att.reintentoOfUsuario + '_' + att.numeroIntento">
          <div class="border-start ps-3 pt-2 small">
            <div><b>Fecha:</b> {{ att.fecha | date:'medium' }}</div>
            <div><b>Mensaje:</b> {{ att.mensaje }}</div>
          </div>
        </div>
      </div>

      <!-- Backups de la fase -->
      <div *ngIf="fase.backups.length" class="mt-3 ms-3">
        <h6 class="small fw-semibold mb-1">Backups</h6>

        <div *ngFor="let b of fase.backups" 
             class="d-flex align-items-center gap-2 mb-1">
          <span class="badge bg-info">
            {{ b.reintentoOfUsuario }}/{{ b.numeroIntento }}
          </span>
          <span>{{ b.fechaBackup | date:'short' }}</span>
          <button class="btn btn-link p-0"
                  *ngIf="b.descargable"
                  (click)="descargar(b)"
                  title="Descargar">
            <i class="fas fa-download"></i>
          </button>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Footer -->
<div class="modal-footer justify-content-end">
  <button type="button" class="btn btn-secondary" (click)="close()">
    Cerrar
  </button>
</div>
